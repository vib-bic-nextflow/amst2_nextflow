nextflow_process {

    name "Test Process stack_alignment"
    script "../sq_stack_alignment.nf"
    process "ELASTIX_STACK_ALIGNMENT"
    tag "modules"
    tag "modules_local"
    tag "prealignment"
    tag "stack_alignment"

    test("stack_alignment_sbs") {

        when {
            params {
               module_args= "--determine_bounds --initialize_offsets_method init_elx  --gaussian_sigma 2  --transform translation --auto_mask non-zero --z_step 1 "
            }
            process {
                config "/home/tatiana/nextflow_bic/amst2_nextflow/modules/local/stack_alignment/tests/nextflow.config"
                """
                input[0] = tuple(
                    "/home/tatiana/test_amst2/input",                    
                    "sbs.json",
                )
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.json_transform[0].size() == 32 },
                { assert path(process.out.json_transform[0]).exists() },
                {assert snapshot(process.out).match("stack_alignment_sbs")}
            )
        }
    }

     test("stack_alignment_nsbs") {

        when {
            params {
               module_args= "--gaussian_sigma 2  --transform translation --auto_mask non-zero --z_step 8 "
            }
            process {
                config "/home/tatiana/nextflow_bic/amst2_nextflow/modules/local/stack_alignment/tests/nextflow.config"
                """
                input[0] = tuple(
                    "/home/tatiana/input_amst/input",                    
                    "nsbs.json",
                )
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.json_transform.size() >= 1 },
                { assert path(process.out.json_transform[0]).exists() },
                {assert snapshot(process.out.json_transform[0]).match("stack_alignment_nsbs")}
            )
        }
    }

    test("stub") {

        options "-stub"

        when {
            params {
               module_args= "--determine_bounds --initialize_offsets_method init_elx  --gaussian_sigma 2  --transform translation --auto_mask non-zero --z_step 1 "
            }
            process {
                config "/home/tatiana/nextflow_bic/amst2_nextflow/modules/local/stack_alignment/tests/nextflow.config"
                """
                input[0] = tuple(
                    "/home/tatiana/input_amst/input",                    
                    "sbs.json",
                )
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match()}
            )
        }
    }
}
